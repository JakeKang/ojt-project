# 채팅의 원리

정리에 앞서 채팅의 원리를 짚고 가자.

### 채팅 시스템의 구조

1. 채팅 서버를 실행시키면 소켓 통신을 위해, 주어진 포트 번호의 서버 소켓이 생성된다.
   서버 소켓은 단순히 기다리고 있다가, 클라이언트 측에서 처음 접속할 때 클라이언트 소켓과의 통신을 위한 서버 측의 소켓을 생성해주는 역할만을 한다.

2. 클라이언트에서는 서버의 아이피(IP), 포트 번호 그리고 ID를 가지고 서버에 접속한다.

3. 이때 클라이언트에서 서버 소켓으로 접속을 시도한다.
클라이언트 소켓의 접속이 서버에서 수락되면, 서버는 클라이언트와 통신을 하기 위해서 서버 측의 소켓을 생성한다.
   이 통로는 스트림으로 연결되며, 한번 열린 스트림은 이후 지속해서 데이터를 보내고 받는 역할을 한다.

4. 서버에서는 클라이언트에서 보내오는 메시지를 받아, 이것을 다시 모든 클라이언트로 보내주기 위한 스레드를 생성한다. 
이 스레드는 메시지를 끊임없이 받고 또 받은 즉시 그 메시지를 내보내는 채팅의 중추적인 역할을 하는 것으로 보통 while 문이나 for 문으로 무한루프를 돌면서 작동한다.

5. 클라이언트도 역시 서버에서 보내오는 메시지를 계속 받아 화면에 출력하기 위한 스레드를 생성한다.
   역시 같은 방식으로, 무한 루프를 돌면서, 서버에서 들어오는 메시지가 있을 때마다 받아서 화면에 출력한다.

6. 클라이언트에서 보낸 메시지를 서버의 스레드에서 받아서 메시지 전송을 요청한다.

7. 그 메시지를 다시 모든 클라이언트로 전송하여, 클라이언트의 스레드를 통해서 프레임에 출력하게 한다.

## Client/Server
- 프로토콜이라고 하는 정해진 규약에 따라 서로 메시지를 주고받는다.
- 웹의 대표적인 프로토콜은 http가 있다.
- 클라이언트는 서버가 어떤 식으로 요청을 처리하는지에 대해서 신경 쓸 필요도 없고, 알기도 어렵다.
- 추상화된 인터페이스(API:Application programing Interface)를 바탕으로 원격 서버에 요청하고 응답에 대해 적절한 형태로 화면에 표시한다.

### Client
- 서버에게 접속하기 위한 접속 단말기
- 서버 입장에서 보면 유저 한 명 한 명이 모두 클라이언트다.
- 웹브라우저는 웹서버로 접속하기 위한 터미널
- 서버에게 자료를 request하고, 서버가 주는 response를 받는다.
- 사용자 입력을 주로 수행
- 현대의 복잡한 시스템은 클라이언트이면서 서버의 역할을 동시에 수행하는 경우도 있다.

### Server
- 서비스를 제공하는 컴퓨터, 클라이언트 컴퓨터 요청을 처리하기 위해 존재한다.
- Web Server, File Server 등
- 웹페이지 지원, 공유 데이터의 처리 및 저장 등의 비즈니스 로직 수행
- 사용자의 거리도 속도와 상관관계가 있다.

## Pub/Sub
메시지를 보내고 (Publish : 발행) 받는 (Subscribe : 구독) 형태의 통신

### 실생활 예제
1. 우체부(Publisher 쪽은)가 편지(Message)를 넣는다.
2. 편지(Message)는 우체통(Broker or Channel)에 넣는다.
3. 각 집의 호수(Topic)에 맞게끔 편지(Message)를 넣는다.
4. 우리(Subscriber)는 우체통에 들어 있는 편지를 가져간다.

Topic이라는 주소를 정해놓고 Publisher 쪽은 특정 topic에 Publish를 하고 Subscriber도 특정 Topic을 뒤져서 메시지를 가져가면 된다.

### 순서
1. 하나의 채널을 열어 놓는다.
2. 여러 개의 프로그램 혹은 여러 서버가 해당 채널을 구독한다.
3. 서버에서 이벤트가 발생한다.
4. 모든 구독자가 해당 이벤트를 받을 수 있다.

### 특징
- Publisher Subscriber가 1:1 관계가 아니라 1:N 관계다.
- 장점 : 중간 브로커(Topic)가 있으므로 안정적이다. 확장성이 용이하다.
- 단점 : 느리다. 서로 주고받을 때 한 브로커(Topic)를 거쳐서 가므로 속도가 느리다.

## Broadcasting
일반적으로 데이터를 전송할 때, 복수의 단말 장치에 대해 동일한 정보나 메시지를 일제히 전송하는 통신 기술을 일컫는다.

- 1 대 전체
- 로컬 랜 상에 붙어있는(브로드캐스트 도메인 안에 있는) 모든 네트워크 장비들에 보내는 통신이다.
- 브로드캐스트의 주소는 FFFF.FFFF.FFFF(MAC) 이다.
- 이 주소로 패킷을 CPU가 받으면 무조건 읽어 들인다.
  (원래 자신의 맥 어드레스와 목적지 맥 어드레스가 다르면 버린다.)
- 브로드캐스트는 네트워크상의 전체 노드로 전송되기 때문에 전체 트래픽이 증가한다.
- 이 패킷을 받은 CPU는 이 패킷을 처리하게 되고 PC의 성능도 떨어진다.
- 즉, 과도한 브로드캐스트는 전체 네트워크 성능뿐만 아니라 PC의 성능도 떨어지게 한다.

## Unicast
- 1 대 1 통신
- 가장 많이 사용되는 트래픽
- 즉, 받는 사람의 주소와 보내는 사람 주소를 적은 뒤 우체통에 넣는 방식
- 그러면 모든 PC가 이 프레임을 받아들여서 받은 사람이 자신인지 비교(맥 어드레스를 통해 비교)
- 자신의 맥 어드레스와 목적지의 맥 어드레스가 다르면 버린다.
- 자신의 맥 어드레스와 목적지의 맥 어드레스가 같으면 읽는다.
- 유니캐스트는 목적지 주소가 아닌 다른 PC들의 CPU 성능을 저하하지 않는다.

## Multicast
- 1 대 n
- 네트워크상에 200명의 사용자가 있을 때, 150명에게만 정보를 보내고 싶을 때 사용하는 통신
- 브로드캐스트를 사용하면 전체 트래픽이 증가하고 네트워크상의 PC의 성능이 떨어지지만
- 멀티캐스트를 사용하면 전달받을 PC만 받기 때문에 받지 않는 PC는 영향이 없다.
- 브로드캐스트와 유니캐스트의 문제점을 해결하기 위해 존재한다.